import { useEffect, useState } from "react"
import clsx from "clsx";
import { ShoppingCartIcon, UserIcon } from "@heroicons/react/20/solid";
import { Link, useRouterState } from "@tanstack/react-router";
import { useTranslation } from "react-i18next";
import { useAtom } from "jotai";
import { cartAtom, localeAtom, supportedLocalesAtom } from "../state/atoms";
import { totalItems, totalPrice } from "../functions/cart";
import { defaultShopSearchFilters } from "../routes/shop";

export default function Navbar() {
    const [isAtTop, setIsAtTop] = useState(true);
    const [cart] = useAtom(cartAtom);

    const { t, i18n } = useTranslation();
    const [supportedLocales] = useAtom(supportedLocalesAtom)
    const [supportedLocalesCursor, setSupportedLocalesCursor] = useState(0)
    const [localeIconPath, setLocaleIconPath] = useState("")

    const [locale, setLocale] = useAtom(localeAtom);
    const routerState = useRouterState();


    useEffect(() => {
        if (window.location.pathname == '/') {
            window.addEventListener('scroll', () => {
                setIsAtTop(window.scrollY == 0);
            })
        } else {
            setIsAtTop(false);
        }
    });

    useEffect(() => {
        const tmp = supportedLocales.find(loc => loc.name === locale);

        if (!tmp) {
            setLocaleIconPath(supportedLocales[0].iconFilename);
            setSupportedLocalesCursor(0);
        }

        const index = supportedLocales.indexOf(tmp!);

        setLocaleIconPath(tmp!.iconFilename);
        setSupportedLocalesCursor(index);
    }, []);

    function handleLocaleChange() {
        const newCursor = supportedLocalesCursor + 1;

        setSupportedLocalesCursor(newCursor);

        const newLocale = supportedLocales[newCursor % supportedLocales.length];

        setLocale(newLocale.name)
        setLocaleIconPath(newLocale.iconFilename);
        i18n.changeLanguage(newLocale.name);
    }

    return (
        <div key={routerState.location.href} className={clsx(
            "w-full text-white flex justify-center items-center fixed top-[0] z-10 transition-colors duration-300 px-6 py-4",
            {
                'bg-(--foreground)': !isAtTop,
                'bg-transparent': isAtTop
            }
        )}>
            <div className="w-7xl text-[#EBE7D9] flex justify-between items-center">
                <div className="flex gap-x-9 font-[Montserrat] font-semibold relative">
                    <Link
                        to={"/"}
                    >
                        {t("home_navbar_text")}
                    </Link>
                    <Link
                        to={"/services"} search={{ page: 0 }}
                    >
                        {t("services_navbar_text")}
                    </Link>
                    <Link
                        to={"/shop"} search={defaultShopSearchFilters}
                    >
                        {t("catalog_navbar_text")}
                    </Link>
                    <Link
                        to={"/info"}
                    >
                        {t("about_navbar_text")}
                    </Link>
                    <Link
                        to={"/projects"}
                    >
                        {t("projects_navbar_text")}
                    </Link>
                </div>
                <div className="absolute left-[50%] top-[50%]" style={{ transform: "translate(-50%, -50%)" }}>
                    {/* <img src="svg/logo_white.svg" alt="logo" className="h-[50px]" /> */}
                    <svg className="h-[50px] w-[150px]" width="1933" height="676" viewBox="0 0 1933 676" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <g clipPath="url(#clip0_2_32)">
                            <path d="M48.1342 551.232C64.1202 551.232 76.6974 555.051 85.8658 562.687C95.0342 570.324 99.6184 580.838 99.6184 594.231C99.6184 607.625 95.0342 618.139 85.8658 625.776C76.6974 633.412 64.1202 637.23 48.1342 637.23H17.6316V674.59H0V551.232H48.1342ZM47.6053 621.899C58.7719 621.899 67.2939 619.52 73.1711 614.762C79.0482 610.004 81.9868 603.16 81.9868 594.231C81.9868 585.303 79.0482 578.459 73.1711 573.701C67.2939 568.943 58.7719 566.564 47.6053 566.564H17.6316V621.899H47.6053ZM212.461 628.419C212.461 629.711 212.343 631.415 212.108 633.53H136.292C137.35 641.753 140.964 648.362 147.136 653.355C153.307 658.348 160.976 660.845 170.145 660.845C181.311 660.845 190.304 657.085 197.121 649.566L206.466 660.492C202.234 665.426 196.974 669.186 190.686 671.77C184.397 674.355 177.374 675.647 169.616 675.647C159.742 675.647 150.985 673.621 143.345 669.568C135.704 665.514 129.798 659.846 125.625 652.562C121.452 645.278 119.366 637.054 119.366 627.89C119.366 618.844 121.393 610.679 125.449 603.395C129.504 596.111 135.087 590.443 142.199 586.389C149.31 582.336 157.332 580.31 166.266 580.31C175.199 580.31 183.163 582.336 190.157 586.389C197.15 590.443 202.616 596.111 206.554 603.395C210.492 610.679 212.461 619.02 212.461 628.419ZM166.266 594.584C158.155 594.584 151.367 597.051 145.901 601.985C140.436 606.92 137.232 613.381 136.292 621.37H196.239C195.299 613.499 192.096 607.066 186.63 602.073C181.164 597.08 174.376 594.584 166.266 594.584ZM257.421 596.875C260.36 591.471 264.709 587.359 270.468 584.539C276.228 581.719 283.222 580.31 291.45 580.31V596.699C290.51 596.581 289.217 596.522 287.571 596.522C278.403 596.522 271.203 599.254 265.972 604.717C260.742 610.18 258.126 617.963 258.126 628.067V674.59H241.2V581.191H257.421V596.875ZM352.984 556.695C342.875 556.695 337.821 562.158 337.821 573.084V581.191H364.974V595.113H338.174V674.59H321.247V595.113H305.379V581.191H321.247V572.908C321.247 563.627 323.951 556.284 329.358 550.88C334.765 545.476 342.347 542.774 352.103 542.774C355.864 542.774 359.39 543.244 362.682 544.183C365.973 545.123 368.794 546.474 371.145 548.237L366.032 561.101C362.153 558.164 357.804 556.695 352.984 556.695ZM424.921 675.647C415.635 675.647 407.29 673.591 399.884 669.48C392.479 665.368 386.69 659.699 382.517 652.474C378.344 645.249 376.258 637.054 376.258 627.89C376.258 618.727 378.344 610.532 382.517 603.307C386.69 596.082 392.479 590.443 399.884 586.389C407.29 582.336 415.635 580.31 424.921 580.31C434.207 580.31 442.523 582.336 449.87 586.389C457.216 590.443 462.976 596.082 467.149 603.307C471.322 610.532 473.408 618.727 473.408 627.89C473.408 637.054 471.322 645.249 467.149 652.474C462.976 659.699 457.216 665.368 449.87 669.48C442.523 673.591 434.207 675.647 424.921 675.647ZM424.921 660.845C430.916 660.845 436.293 659.464 441.054 656.703C445.815 653.942 449.547 650.065 452.25 645.072C454.954 640.079 456.305 634.352 456.305 627.89C456.305 621.429 454.954 615.702 452.25 610.708C449.547 605.715 445.815 601.868 441.054 599.166C436.293 596.464 430.916 595.113 424.921 595.113C418.926 595.113 413.549 596.464 408.788 599.166C404.028 601.868 400.266 605.715 397.504 610.708C394.742 615.702 393.361 621.429 393.361 627.89C393.361 634.352 394.742 640.079 397.504 645.072C400.266 650.065 404.028 653.942 408.788 656.703C413.549 659.464 418.926 660.845 424.921 660.845ZM518.368 596.875C521.307 591.471 525.656 587.359 531.416 584.539C537.175 581.719 544.169 580.31 552.397 580.31V596.699C551.457 596.581 550.164 596.522 548.518 596.522C539.35 596.522 532.151 599.254 526.92 604.717C521.689 610.18 519.074 617.963 519.074 628.067V674.59H502.147V581.191H518.368V596.875ZM695.39 580.31C707.144 580.31 716.459 583.717 723.336 590.531C730.212 597.345 733.65 607.448 733.65 620.841V674.59H716.724V622.78C716.724 613.734 714.637 606.92 710.465 602.338C706.292 597.756 700.326 595.465 692.569 595.465C683.988 595.465 677.17 598.138 672.116 603.483C667.061 608.829 664.534 616.495 664.534 626.481V674.59H647.608V622.78C647.608 613.734 645.522 606.92 641.349 602.338C637.176 597.756 631.211 595.465 623.453 595.465C614.872 595.465 608.054 598.138 603 603.483C597.946 608.829 595.418 616.495 595.418 626.481V674.59H578.492V581.191H594.713V595.113C598.122 590.296 602.589 586.624 608.113 584.098C613.638 581.573 619.926 580.31 626.979 580.31C634.267 580.31 640.732 581.778 646.374 584.715C652.016 587.652 656.365 591.94 659.421 597.58C662.947 592.175 667.855 587.946 674.143 584.891C680.432 581.837 687.514 580.31 695.39 580.31ZM804.176 580.31C817.106 580.31 827.009 583.482 833.886 589.826C840.762 596.17 844.2 605.627 844.2 618.198V674.59H828.155V662.254C825.334 666.601 821.308 669.92 816.078 672.211C810.847 674.502 804.647 675.647 797.476 675.647C787.015 675.647 778.64 673.122 772.351 668.07C766.063 663.018 762.919 656.38 762.919 648.156C762.919 639.932 765.916 633.324 771.911 628.331C777.905 623.338 787.426 620.841 800.474 620.841H827.274V617.493C827.274 610.209 825.158 604.629 820.926 600.752C816.695 596.875 810.465 594.936 802.237 594.936C796.712 594.936 791.305 595.847 786.016 597.668C780.726 599.489 776.26 601.927 772.616 604.981L765.563 592.293C770.383 588.416 776.142 585.45 782.842 583.394C789.542 581.338 796.654 580.31 804.176 580.31ZM800.297 662.607C806.762 662.607 812.346 661.168 817.047 658.289C821.749 655.411 825.158 651.328 827.274 646.042V633.001H801.179C786.839 633.001 779.669 637.818 779.669 647.451C779.669 652.151 781.49 655.851 785.134 658.554C788.778 661.256 793.833 662.607 800.297 662.607ZM930.771 580.31C942.643 580.31 952.076 583.746 959.07 590.619C966.064 597.492 969.561 607.566 969.561 620.841V674.59H952.634V622.78C952.634 613.734 950.46 606.92 946.111 602.338C941.761 597.756 935.532 595.465 927.421 595.465C918.253 595.465 911.024 598.138 905.734 603.483C900.445 608.829 897.8 616.495 897.8 626.481V674.59H880.874V581.191H897.095V595.289C900.504 590.472 905.117 586.771 910.936 584.187C916.754 581.602 923.366 580.31 930.771 580.31ZM1047.49 675.647C1037.97 675.647 1029.48 673.591 1022.01 669.48C1014.55 665.368 1008.7 659.699 1004.47 652.474C1000.24 645.249 998.124 637.054 998.124 627.89C998.124 618.727 1000.24 610.532 1004.47 603.307C1008.7 596.082 1014.55 590.443 1022.01 586.389C1029.48 582.336 1037.97 580.31 1047.49 580.31C1055.96 580.31 1063.51 582.013 1070.15 585.42C1076.79 588.827 1081.93 593.761 1085.58 600.223L1072.71 608.506C1069.77 604.041 1066.12 600.693 1061.77 598.461C1057.42 596.229 1052.61 595.113 1047.32 595.113C1041.2 595.113 1035.71 596.464 1030.83 599.166C1025.95 601.868 1022.13 605.715 1019.37 610.708C1016.61 615.702 1015.23 621.429 1015.23 627.89C1015.23 634.469 1016.61 640.256 1019.37 645.249C1022.13 650.242 1025.95 654.089 1030.83 656.791C1035.71 659.493 1041.2 660.845 1047.32 660.845C1052.61 660.845 1057.42 659.728 1061.77 657.496C1066.12 655.264 1069.77 651.916 1072.71 647.451L1085.58 655.558C1081.93 662.019 1076.79 666.983 1070.15 670.449C1063.51 673.915 1055.96 675.647 1047.49 675.647ZM1195.77 628.419C1195.77 629.711 1195.66 631.415 1195.42 633.53H1119.61C1120.66 641.753 1124.28 648.362 1130.45 653.355C1136.62 658.348 1144.29 660.845 1153.46 660.845C1164.62 660.845 1173.62 657.085 1180.43 649.566L1189.78 660.492C1185.55 665.426 1180.29 669.186 1174 671.77C1167.71 674.355 1160.69 675.647 1152.93 675.647C1143.06 675.647 1134.3 673.621 1126.66 669.568C1119.02 665.514 1113.11 659.846 1108.94 652.562C1104.77 645.278 1102.68 637.054 1102.68 627.89C1102.68 618.844 1104.71 610.679 1108.76 603.395C1112.82 596.111 1118.4 590.443 1125.51 586.389C1132.62 582.336 1140.65 580.31 1149.58 580.31C1158.51 580.31 1166.48 582.336 1173.47 586.389C1180.46 590.443 1185.93 596.111 1189.87 603.395C1193.8 610.679 1195.77 619.02 1195.77 628.419ZM1149.58 594.584C1141.47 594.584 1134.68 597.051 1129.21 601.985C1123.75 606.92 1120.55 613.381 1119.61 621.37H1179.55C1178.61 613.499 1175.41 607.066 1169.94 602.073C1164.48 597.08 1157.69 594.584 1149.58 594.584ZM1365.21 652.386V612.206H1382.14V660.316C1376.03 665.368 1368.92 669.245 1360.81 671.947C1352.69 674.649 1344.23 676 1335.42 676C1322.96 676 1311.73 673.268 1301.74 667.805C1291.75 662.342 1283.9 654.823 1278.2 645.249C1272.5 635.674 1269.65 624.895 1269.65 612.911C1269.65 600.928 1272.5 590.119 1278.2 580.486C1283.9 570.852 1291.78 563.333 1301.83 557.929C1311.88 552.525 1323.19 549.823 1335.77 549.823C1345.64 549.823 1354.6 551.438 1362.66 554.669C1370.71 557.9 1377.56 562.628 1383.2 568.855L1372.27 579.781C1362.39 570.265 1350.46 565.507 1336.47 565.507C1327.07 565.507 1318.64 567.533 1311.17 571.586C1303.71 575.64 1297.86 581.279 1293.63 588.504C1289.4 595.729 1287.28 603.865 1287.28 612.911C1287.28 621.84 1289.4 629.917 1293.63 637.142C1297.86 644.367 1303.71 650.036 1311.17 654.148C1318.64 658.26 1327.01 660.316 1336.3 660.316C1347.35 660.316 1356.99 657.672 1365.21 652.386ZM1535.53 580.31C1547.29 580.31 1556.6 583.717 1563.48 590.531C1570.36 597.345 1573.79 607.448 1573.79 620.841V674.59H1556.87V622.78C1556.87 613.734 1554.78 606.92 1550.61 602.338C1546.44 597.756 1540.47 595.465 1532.71 595.465C1524.13 595.465 1517.31 598.138 1512.26 603.483C1507.21 608.829 1504.68 616.495 1504.68 626.481V674.59H1487.75V622.78C1487.75 613.734 1485.67 606.92 1481.49 602.338C1477.32 597.756 1471.36 595.465 1463.6 595.465C1455.02 595.465 1448.2 598.138 1443.14 603.483C1438.09 608.829 1435.56 616.495 1435.56 626.481V674.59H1418.64V581.191H1434.86V595.113C1438.27 590.296 1442.73 586.624 1448.26 584.098C1453.78 581.573 1460.07 580.31 1467.12 580.31C1474.41 580.31 1480.88 581.778 1486.52 584.715C1492.16 587.652 1496.51 591.94 1499.57 597.58C1503.09 592.175 1508 587.946 1514.29 584.891C1520.58 581.837 1527.66 580.31 1535.53 580.31ZM1659.84 580.31C1668.89 580.31 1677 582.307 1684.17 586.301C1691.34 590.296 1696.95 595.876 1701.01 603.043C1705.06 610.209 1707.09 618.492 1707.09 627.89C1707.09 637.289 1705.06 645.601 1701.01 652.826C1696.95 660.052 1691.34 665.661 1684.17 669.656C1677 673.65 1668.89 675.647 1659.84 675.647C1652.9 675.647 1646.55 674.296 1640.79 671.594C1635.04 668.892 1630.27 664.956 1626.51 659.787V674.59H1610.29V543.831H1627.22V595.289C1630.98 590.354 1635.68 586.624 1641.32 584.098C1646.97 581.573 1653.14 580.31 1659.84 580.31ZM1658.43 660.845C1664.42 660.845 1669.8 659.464 1674.56 656.703C1679.32 653.942 1683.08 650.065 1685.84 645.072C1688.61 640.079 1689.99 634.352 1689.99 627.89C1689.99 621.429 1688.61 615.702 1685.84 610.708C1683.08 605.715 1679.32 601.868 1674.56 599.166C1669.8 596.464 1664.42 595.113 1658.43 595.113C1652.55 595.113 1647.2 596.464 1642.38 599.166C1637.56 601.868 1633.8 605.715 1631.1 610.708C1628.39 615.702 1627.04 621.429 1627.04 627.89C1627.04 634.352 1628.39 640.079 1631.1 645.072C1633.8 650.065 1637.56 653.942 1642.38 656.703C1647.2 659.464 1652.55 660.845 1658.43 660.845ZM1826.81 551.232H1844.44V674.59H1826.81V619.608H1755.93V674.59H1738.3V551.232H1755.93V604.276H1826.81V551.232Z" className="transition-colors duration-300" fill={clsx({
                                '#F55139': !isAtTop,
                                '#EBE7D9': isAtTop
                            })} />
                        </g>
                        <g clipPath="url(#clip1_2_32)">
                            <path d="M999.298 137.667C999.298 179.115 988.084 214.642 965.657 244.248C943.229 273.854 912.127 294.789 872.35 307.055L949.788 444.087H841.248L771.427 319.743H683.833L659.078 444.087H555.615L644.479 -0.000244141H825.38C880.39 -0.000244141 923.129 12.0536 953.597 36.1612C984.064 60.2688 999.298 94.1041 999.298 137.667ZM787.295 237.904C821.571 237.904 848.124 230.079 866.955 214.431C885.786 198.782 895.201 176.366 895.201 147.183C895.201 126.036 888.007 110.176 873.62 99.6023C859.232 89.0288 838.709 83.742 812.05 83.742H730.803L699.701 237.904H787.295ZM1359.2 444.087L1338.25 348.926H1131.32L1073.56 444.087H963.753L1251.29 -0.000244141H1352.85L1462.02 444.087H1359.2ZM1178.93 270.893H1321.11L1283.66 99.6023L1178.93 270.893ZM1915.86 82.4732H1683.55L1660.06 199.839H1866.35L1849.21 282.313H1644.19L1611.82 444.087H1508.36L1597.22 -0.000244141H1933L1915.86 82.4732Z" fill="#EBE7D9" />
                        </g>
                        <g clipPath="url(#clip2_2_32)">
                            <path d="M0 444.088L241.49 0H338.652L97.1619 444.088H0ZM216.964 444.088L458.453 0H555.615L314.126 444.088H216.964Z" className="transition-colors duration-300" fill={clsx({
                                '#F55139': !isAtTop,
                                '#EBE7D9': isAtTop
                            })} />
                        </g>
                        <defs>
                            <clipPath id="clip0_2_32">
                                <rect width="1844.44" height="133.226" fill="white" transform="translate(0 542.774)" />
                            </clipPath>
                            <clipPath id="clip1_2_32">
                                <rect width="1377.38" height="444.088" fill="white" transform="translate(555.615)" />
                            </clipPath>
                            <clipPath id="clip2_2_32">
                                <rect width="555.615" height="444.088" fill="white" />
                            </clipPath>
                        </defs>
                    </svg>

                </div>
                <div className="flex gap-x-7 font-[Montserrat] font-semibold items-center text-xs leading-[14px]">
                    <div
                        className=""
                    >
                        <NavbarScheduleComponent />
                    </div>
                    <Link
                        to={"/profile"}
                        className="max-w-[50px]"
                    >
                        <UserIcon className="size-7" />
                    </Link>
                    <Link
                        to={"/cart"}
                        className="max-w-[100px]"
                    >
                        <div className="flex gap-x-1 items-center justify-between">
                            <div className="">
                                <ShoppingCartIcon className="size-7" />
                            </div>
                            <div className="">
                                <div className="font-bold">{totalItems(cart)} {t("item_count_text")}</div>
                                <div className="font-bold">{totalPrice(cart)}â‚¬</div>
                            </div>
                        </div>
                    </Link>
                    <div
                        style={{ cursor: "pointer" }}
                        className="max-w-[50px]"
                    >
                        {/* <img src="icons/flags/germany.svg" alt="" className="h-[20px]" /> */}
                        <div className="" onClick={() => handleLocaleChange()}>
                            <img className="w-[30px]" alt="Language icon" src={`../../src/assets/${localeIconPath}`} />
                        </div>
                    </div>
                </div>
            </div>
        </div>
    )
}

function NavbarScheduleComponent() {
    const { t } = useTranslation();

    return (
        <div className="grid gap-x-[5em]" style={{
            gridTemplate: `'a1 b1'
                           'a2 b2'
                           'a3 b3'
                           'a4 a4'
                           `

        }}>
            <div className="ext-left" style={{ gridArea: 'a1' }}>{t("work_schedule_navbar_text_name1")}</div>
            <div className="text-right" style={{ gridArea: 'b1' }}>{t("work_schedule_navbar_text_value1")}</div>
            <div className="ext-left" style={{ gridArea: 'a2' }}>{t("work_schedule_navbar_text_name2")}</div>
            <div className="text-right" style={{ gridArea: 'b2' }}>{t("work_schedule_navbar_text_value2")}</div>
            <div className="text-left" style={{ gridArea: 'a3' }}>{t("work_schedule_navbar_text_name3")}</div>
            <div className="text-right" style={{ gridArea: 'b3' }}>{t("work_schedule_navbar_text_value3")}</div>
            <div className="text-right" style={{ gridArea: 'a4' }}>{t("phone_navbar_text")}</div>
        </div>
    );
}